{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <header class="mb-16 text-center">
        <h2 class="text-4xl md:text-5xl font-bold mb-4 text-vintage-ink">Library Metrics</h2>
        <div class="flex justify-center items-center gap-4 mb-6">
            <div class="h-px w-12 bg-vintage-gold/30"></div>
            <div class="w-2 h-2 rounded-full border border-vintage-gold/30"></div>
            <div class="h-px w-12 bg-vintage-gold/30"></div>
        </div>
        <p class="text-lg italic opacity-60">Quantifying the journey through pages and time.</p>
    </header>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-20">
        <!-- Total Books -->
        <div class="text-center p-8 paper-texture vintage-border relative group hover:-translate-y-1 transition-soft">
            <div
                class="absolute top-0 left-0 w-full h-1 bg-vintage-gold opacity-20 group-hover:opacity-100 transition-soft">
            </div>
            <h3 class="text-xs uppercase tracking-[0.2em] opacity-40 mb-2 font-bold">Volumes Completed</h3>
            <p class="text-5xl md:text-6xl font-bold font-serif-display text-vintage-accent">{{ total_books }}</p>
        </div>

        <!-- Total Pages -->
        <div class="text-center p-8 paper-texture vintage-border relative group hover:-translate-y-1 transition-soft">
            <div
                class="absolute top-0 left-0 w-full h-1 bg-vintage-gold opacity-20 group-hover:opacity-100 transition-soft">
            </div>
            <h3 class="text-xs uppercase tracking-[0.2em] opacity-40 mb-2 font-bold">Pages Turned</h3>
            <p class="text-5xl md:text-6xl font-bold font-serif-display text-vintage-ink">{{ "{:,}".format(total_pages)
                }}</p>
        </div>

        <!-- Avg Pages -->
        <div class="text-center p-8 paper-texture vintage-border relative group hover:-translate-y-1 transition-soft">
            <div
                class="absolute top-0 left-0 w-full h-1 bg-vintage-gold opacity-20 group-hover:opacity-100 transition-soft">
            </div>
            <h3 class="text-xs uppercase tracking-[0.2em] opacity-40 mb-2 font-bold">Avg. Length</h3>
            <p class="text-5xl md:text-6xl font-bold font-serif-display text-vintage-ink opacity-70">{{ avg_pages }}</p>
            <span class="text-xs italic opacity-40">pages/vol</span>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-20">
        <!-- Reading Activity Chart -->
        <div class="space-y-6">
            <div class="flex items-baseline justify-between border-b border-black/5 pb-2">
                <h3 class="text-xl font-bold italic text-vintage-accent opacity-80">Chronicle of Activity</h3>
            </div>
            <div class="paper-texture p-6 vintage-border h-[300px]">
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <!-- Categories Chart -->
        <div class="space-y-6">
            <div class="flex items-baseline justify-between border-b border-black/5 pb-2">
                <h3 class="text-xl font-bold italic text-vintage-accent opacity-80">Distribution of Wisdom</h3>
            </div>
            <div class="paper-texture p-6 vintage-border h-[300px] flex items-center justify-center">
                <canvas id="categoriesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 text-sm">
        <!-- Top Authors -->
        <div>
            <div class="flex items-baseline justify-between mb-6 border-b border-black/5 pb-2">
                <h3 class="text-xl font-bold italic text-vintage-ink opacity-90">Most Read Authors</h3>
            </div>

            {% if top_authors %}
            <ul class="space-y-4">
                {% for author, count in top_authors %}
                <li class="flex items-center justify-between group">
                    <span class="font-medium opacity-80 group-hover:text-vintage-accent transition-colors">{{ author
                        }}</span>
                    <div class="flex items-center gap-3">
                        <div class="h-px w-16 bg-black/5 group-hover:bg-vintage-gold/30 transition-colors"></div>
                        <span class="font-serif-display font-bold text-lg">{{ count }}</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="italic opacity-40">Not enough data to determine favorites.</p>
            {% endif %}
        </div>

        <!-- Monthly Breakdown (Text) -->
        <div>
            <div class="flex items-baseline justify-between mb-6 border-b border-black/5 pb-2">
                <h3 class="text-xl font-bold italic text-vintage-ink opacity-90">Monthly Ledger</h3>
            </div>

            {% if books_by_year_month %}
            <div class="space-y-6 h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                {% for year, months in books_by_year_month.items()|sort(reverse=True) %}
                <div>
                    <h4
                        class="text-xs uppercase tracking-widest font-bold mb-3 opacity-40 sticky top-0 bg-vintage-cream z-10 py-1">
                        {{ year }}</h4>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                        {% for month in ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August',
                        'September', 'October', 'November', 'December'] %}
                        {% if month in months %}
                        <div class="flex justify-between items-center py-1 border-b border-dashed border-black/5">
                            <span class="italic opacity-70">{{ month }}</span>
                            <span class="font-bold text-vintage-accent">{{ months[month] }}</span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="italic opacity-40">No records found.</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Configuration
    Chart.defaults.font.family = "'EB Garamond', serif";
    Chart.defaults.color = 'rgba(26, 22, 20, 0.6)';

    // Activity Chart (Pages per Year)
    const pagesCtx = document.getElementById('activityChart').getContext('2d');
    const pagesData = {{ pages_by_year| tojson }};
    const years = Object.keys(pagesData).sort();

    new Chart(pagesCtx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Pages Read',
                data: years.map(y => pagesData[y]),
                borderColor: '#b58d4a',
                backgroundColor: 'rgba(181, 141, 74, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#2d4a3e',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { display: false }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Categories Chart
    const catsCtx = document.getElementById('categoriesChart').getContext('2d');
    const catsData = {{ top_categories| tojson }};

    new Chart(catsCtx, {
        type: 'doughnut',
        data: {
            labels: catsData.map(c => c[0]),
            datasets: [{
                data: catsData.map(c => c[1]),
                backgroundColor: [
                    '#2d4a3e', // emerald
                    '#b58d4a', // gold
                    '#1a1614', // ink
                    '#8c7b75', // taupe
                    '#d4c5b0'  // beige
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { boxWidth: 12 }
                }
            },
            cutout: '70%'
        }
    });
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(26, 22, 20, 0.1);
        border-radius: 4px;
    }
</style>
{% endblock %}